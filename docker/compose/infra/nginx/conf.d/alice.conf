# ---------- Globale Helfer ----------
# CORS: nur Domains erlauben die gebraucht werden
map $http_origin $cors_origin {
    default "";
    "~^https?://(alice|ollama3090|ollamatitan|openwebui|n8n)\.happy-mining\.de$" $http_origin;
}

server {
  listen 80;
  server_name alice.happy-mining.de;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl;
  http2 on;
  server_name alice.happy-mining.de;

  # TLS
  ssl_certificate     /etc/nginx/certs/fullchain.pem;
  ssl_certificate_key /etc/nginx/certs/private-key.pem;
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_session_cache shared:SSL:10m;
  add_header Strict-Transport-Security "max-age=31536000" always;

  resolver 127.0.0.11 ipv6=off valid=30s;

  # Gemeinsame Proxy-Header, auch fÃ¼r WebSockets
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Authorization     $http_authorization;
  proxy_set_header Upgrade           $http_upgrade;
  proxy_set_header Connection        $connection_upgrade;

  set $n8n_upstream http://n8n:5678;

  # ---------- HA-PROD: /v1/* -> n8n /webhook/* ----------
  location ^~ /v1/ {
    # CORS
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Vary Origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # add_header Access-Control-Allow-Credentials "true" always;

    if ($request_method = OPTIONS) {
      return 204;
    }

    # mappe /v1/... -> /webhook/...
    rewrite ^/v1/(.*)$ /webhook/v1/$1 break;
    proxy_pass $n8n_upstream;
    proxy_read_timeout 3600s;
  }

  # ---------- HA-TEST: /vtest/* -> n8n /webhook-test/* ----------
  location ^~ /vtest/ {
    # CORS
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Vary Origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # add_header Access-Control-Allow-Credentials "true" always;

    if ($request_method = OPTIONS) {
      return 204;
    }

    # mappe /vtest/... -> /webhook-test/...
    rewrite ^/vtest/(.*)$ /webhook-test/v1/$1 break;
    proxy_pass $n8n_upstream;
    proxy_read_timeout 3600s;
  }

  # ---- Direktdurchreichung: /webhook-test/* -> n8n ----
  location ^~ /webhook-test/ {
    # CORS
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Vary Origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # add_header Access-Control-Allow-Credentials "true" always;

    if ($request_method = OPTIONS) { return 204; }

    proxy_pass $n8n_upstream;
    proxy_read_timeout 3600s;
  }

  # ---- Direktdurchreichung: /webhook/* -> n8n ----
  location ^~ /webhook/ {
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Vary Origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass $n8n_upstream;
    proxy_read_timeout 3600s;
  }

  # ---- /api/webhook/* -> n8n (strips /api prefix) ----
  # Frontend uses /api/webhook/auth/... for auth endpoints via n8n proxy
  location ^~ /api/webhook/ {
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Vary Origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    if ($request_method = OPTIONS) { return 204; }

    rewrite ^/api(.*)$ $1 break;
    proxy_pass $n8n_upstream;
    proxy_read_timeout 3600s;
  }

  # ---- Direktdurchreichung: /webhook-waiting/* -> n8n ----
  location ^~ /webhook-waiting/ {
    # CORS
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Vary Origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # add_header Access-Control-Allow-Credentials "true" always;

    if ($request_method = OPTIONS) { return 204; }

    proxy_pass $n8n_upstream;
    proxy_read_timeout 3600s;
  }

  # Optional: statische Seite
  location / {
    root /usr/share/nginx/html;
    index index.html;
    try_files $uri $uri/ =404;
  }
}
