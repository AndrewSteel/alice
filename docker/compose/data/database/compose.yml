services:
  postgres:
    image: postgres:16
    container_name: postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB="${PGDB}"
      - POSTGRES_USER="${PGUSER}"
      - POSTGRES_PASSWORD="${PGPASSWORD}"
    volumes:
      - /srv/warm/postgres:/var/lib/postgresql/data
    networks:
      db_int: {}
      backend:
        aliases: [postgres]
    healthcheck:
      test: ["CMD-SHELL","pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: ["redis-server","--save","60","1000","--appendonly","yes"]
    volumes:
      - /srv/hot/redis:/data
    networks:
      db_int: {}
      backend:
        aliases: [redis]
    healthcheck:
      test: ["CMD","redis-cli","ping"]
      interval: 10s
      timeout: 3s
      retries: 10

networks:
  db_int: {}
  backend:
    external: true
    name: backend
